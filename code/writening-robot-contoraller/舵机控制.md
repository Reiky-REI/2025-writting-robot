## 电机参数
### 状态回读
- 回读ID
- 回读角度
- 回读PID参数
- 最大最小占空比
- 回读目标角度容错偏差
- 回读零点位置偏差
- 回读初始上电所处工作模式
- 回读自我保护“反应时间”
- 回读舵机内部温度
- 回读舵机当前电压
- 回读舵机当前电流

### 控制变量
- 角速度
    同启同停
- 力矩控制

### 工作模式
- 有限角度控制模式 
- 多圈大角度控制模式
- 连续转动模式 
- 阻尼模式
- 待机模式


## 运动控制函数
### 有限角度控制模式下的转动位置及速度函数
```C++
void set_angle(int id_num, float  angle, int step )
``` 
参数及解释： 
> id_num
- 舵机编号范围0~255（除去121,126,127 共253个），默认为0；121（0x79）号为舵机的共同编号（以下统称广播编号），即所有舵机都会响应到控制
指令并执行。 
> angle
- 设置舵机转动角度，可选角度范围为0~270°。 

> step
- 设置舵机运动步数，该参数可调节转动速度。舵机要达到指定角度分步的次数，以10ms为周期每周期最多运动4度，步数设置为“1”时则以最快速度转动，步数越大速度越低。

### 设置转动力矩函数
```C++
void set_torque (int id_num, double torque);
```
参数及解释：
> id_num
- 舵机编号，即要设置第几号舵机的连续转动模式下的转动扭矩，这里可以用广播编号

> torque
- 参数范围（-3~3），参数为正，舵机则正转，反之反转。 （参数的绝对值表示力矩的相对大小）

### 回读状态（get_state）
```C++
int get_state(int id_num, int para_num，int o_m);
```
返回值：
```C++
float servo_rpara[ID,AngleNow,AngleExp,Time,StatesNow,];
```
参数解释：
> 




# 运动学反解

<!-- 对于$\theta_1$

$$
\begin{equation}
\begin{aligned}
\theta_1 &= 2 \cdot arctan(\frac{d_1 \pm \sqrt{d_1^2 + e_1^2 -f_1^2}}{e_1 - f_1}) \\
d_1 &= -2 \cdot l_1 \cdot y_c \\
e_1 &= -2 \cdot l_1 \cdot x_c \\
f_1 &= x_c^2 + y_c^2 + l_1^2 - l_2^2 \\
\end{aligned}
\end{equation}
$$

对于$\theta_4$

$$
\begin{equation}
\begin{aligned}
\theta_4 &= 2 \cdot arctan(\frac{d_2 \pm \sqrt{d_2^2 + e_2^2 -f_2^2}}{e_2 - f_2}) \\
d_2 &= -2 \cdot l_3 \cdot y_c \\
e_2 &= 2 \cdot l_4 \cdot l_5 - 2 \cdot x_c \\
f_2 &= x_c^2 + y_c^2 + l_4^2 -l_3^2 +l_5^2 - 2 \cdot x_c \cdot l_5 \\
\end{aligned}
\end{equation}
$$

对于笔尖坐标系$(x_{pen},y_{pen})$:
$$
\begin{equation}
\begin{aligned}
x_{pen} &= x_c + sin(\theta_0) \cdot l_8 \\
y_{pen} &= y_c + cos(\theta_0) \cdot l_8 \\
\\
l_8 &= l_M - l_7 \cdot cos(\theta_5) \\
l_7 &= cos(\theta_5) \cdot l_6 \\
\theta_5 &= 180^\circ - \theta_2 -\theta_0 \\
\theta_0 &= arctan(\frac{y_c}{x_c - \frac{l_5}{2}}) \\
\theta_2 &= 2 \cdot arctan(\frac{B_0 + \sqrt{A_0^2 + B_0^2 - C_0^2}}{A_0 - C_0}) \\
\\
A_0 &= 2 \cdot l_2(x_D - x_B) \\
B_0 &= 2 \cdot l_2(y_D - y_B) \\
C_0 &= l_2^2 + l_{BD}^2 - l_3^2 \\
l_{BD} &= \sqrt{(x_D - x_B)^2 + (y_D - y_B)^2} \\
\\
x_B &= l_1 \cdot cos(\theta_1) \\
y_B &= l_1 \cdot sin(\theta_1) \\
x_D &= x_{pen} - l_4 \cdot cos(\theta_4) \\
y_D &= y_{pen} - l_4 \cdot sin(\theta_4) \\
\end{aligned}
\end{equation}
$$ -->

通过测量得：
$$
\begin{equation}
\begin{aligned}
l_1 &= 90 \\
l_2 &= 130 \\
l_3 &= 130 \\
l_4 &= 90 \\
l_5 &= 105 \\
l_6 &= 35 \\
l_M &= 95 \\
\end{aligned}
\end{equation}
$$


总公式，从 $(x_{pen},y_{pen})$ 映射到驱动舵机 $(\phi_1,\phi_4)$ 的公式为：
$$
\begin{equation}
\begin{aligned}
\textbf{（1）}
&x_{pen} = x_c + l_M\cos\phi_0,\\[1mm]
&y_{pen} = y_c + l_M\sin\phi_0,\\[1mm]
&\phi_0 = \arctan\Bigl(\frac{y_c}{\,x_c-\frac{l_5}{2}}\Bigr),\\[1mm]
&\phi_5 = 180^\circ - \phi_2 - \phi_0,\\[1mm]
&l_7 = \cos\phi_5l_6,\\[1mm]
\\[1mm]
\textbf{（2）}
&x_B = l_1\cos\phi_1,\quad y_B = l_1\sin\phi_1,\\[1mm]
&x_D = x_{pen} - l_4\cos\phi_4,\quad y_D = y_{pen} - l_4\sin\phi_4,\\[1mm]
&l_{BD} = \sqrt{(x_D - x_B)^2 + (y_D-y_B)^2},\\[1mm]
& A_0 = 2\,l_2(x_D - x_B),\\[1mm]
& B_0 = 2\,l_2(y_D - y_B),\\[1mm]
& C_0 = l_2^2 + l_{BD}^2 - l_3^2,\\[1mm]
&\phi_2 = 2\,\arctan\Bigl(\frac{B_0 + \sqrt{A_0^2+B_0^2-C_0^2}}{\,A_0+C_0}\Bigr),\\[1mm]
\\[1mm]
\textbf{（3）}
&\phi_1 = 2\arctan\Biggl(\frac{d_1 \;\pm\; \sqrt{\,d_1^2+e_1^2-f_1^2\,}}{\,e_1 - f_1}\Biggr),\\[1mm]
&\quad d_1 =2l_2x_{pen} - 2l_2l_M\cos\phi_0,\\[1mm]
&\quad e_1 = 2l_2y_{pen} - 2l_2l_M\sin\phi_0,\\[1mm]
&\quad f_1 = x_{pen}^2+y_{pen}^2+l_2^2+l_M^2-l_1^2-2x_{pen}l_M\cos\phi_0+2y_{pen}l_M\sin\phi_0,\\[1mm]
\\[1mm]
\textbf{（4）}
&\phi_4 = 2\arctan\Biggl(\frac{d_2 \;\pm\; \sqrt{\,d_2^2+e_2^2-f_2^2\,}}{\,e_2 - f_2}\Biggr),\\[1mm]
&\quad d_2 = 2l_4y_{pen}-2l_4l_M\sin\phi_0,\\[1mm]
&\quad e_2 = 2l_4x_{pen}-2l_4l_M\cos\phi_0-2l_4l_5\\[1mm]
&\quad f_2 = x_{pen}^2+y_{pen}^2+l_4^2+l_M^2+l_5^2-l_3^2-2l_Mx_{pen}\cos\phi_0-2l_5x_{pen}+2l_Ml_5\cos\phi_0-2l_Mx_{pen}\sin\phi_0,\\
\end{aligned}
\end{equation}
$$

则根据以上公式可以编写如下代码：
```C++
/**
 * @fn float* cla_angle(float x_pen, float y_pen)
 * @brief 通过笔尖坐标系的坐标计算舵机角度
 * 
 * 该函数根据逆运动学公式组计算从笔尖坐标 \((x_{pen},y_{pen})\) 到驱动舵机角度 \((\theta_1,\theta_4)\) 的映射值。
 * 公式中涉及的中间变量包括：
 *   - 对于舵机1（\(\theta_1\)）：  
 *        d₁ = -2·l₁·y_c  
 *        e₁ = -2·l₁·x_c  
 *        f₁ = x_c² + y_c² + l₁² - l₂²  
 *        \(\theta_1 = 2 \arctan\Bigl(\frac{d₁ \pm \sqrt{d₁^2+e₁^2-f₁^2}}{e₁-f₁}\Bigr)\)
 *   - 对于舵机4（\(\theta_4\)）：  
 *        d₂ = -2·l₃·y_c  
 *        e₂ = 2·l₄·l₅ - 2·x_c  
 *        f₂ = x_c² + y_c² + l₄² - l₃² + l₅² - 2·l₅·x_c  
 *        \(\theta_4 = 2 arctan\Bigl(\frac{d₂ \pm \sqrt{d₂^2+e₂^2-f₂^2}}{e₂-f₂}\Bigr)\)
 *
 * 固定参数根据实际测量得到：
 *   l₁ = 90,  l₂ = 130,  l₃ = 130,  l₄ = 90,  l₅ = 105,  l₆ = 35,  l_M = 150.
 *
 * @param x_pen 笔尖坐标系的 x 坐标
 * @param y_pen 笔尖坐标系的 y 坐标
 * @return float* 返回一个长度为2的数组，其中 angle[0] 为舵机1角度 θ₁，angle[1] 为舵机4角度 θ₄
 */
float* cla_angle(float x_pen, float y_pen) {
    // 静态数组保证在函数返回后数据依然有效
    static float angle[2];

    // 固定参数（单位：毫米或其它统一单位）
    const float l1  = 90.0f;
    const float l2  = 130.0f;
    const float l3  = 130.0f;
    const float l4  = 90.0f;
    const float l5  = 105.0f;
    const float l6  = 35.0f;
    const float lM  = 95.0f;

    // *************************************************************************
    // 【注意】：
    // 公式中涉及中间变量 x_c, y_c 为工作坐标系坐标，通常由笔尖坐标转换得到。
    // 此处为简化计算，假设工作坐标系与笔尖坐标系重合，即：
    float x_c = x_pen;
    float y_c = y_pen;
    // *************************************************************************

    // 计算 φ₀ = arctan( y_pen / (x_pen - l5/2) )
    float phi0 = atan( y_pen / ( x_pen - l5 / 2.0f ) );

    /************* 计算舵机1角度 φ₁ ******************/
    float d1 = 2.0f * l2 * x_pen - 2.0f * l2 * lM * cos(phi0);
    float e1 = 2.0f * l2 * y_pen - 2.0f * l2 * lM * sin(phi0);
    float f1 = x_pen * x_pen + y_pen * y_pen + l2 * l2 + lM * lM - l1 * l1
               - 2.0f * lM * x_pen * cos(phi0) + 2.0f * lM * y_pen * sin(phi0);
    float discriminant1 = d1 * d1 + e1 * e1 - f1 * f1;
    discriminant1 = discriminant1 < 0 ? 0 : discriminant1;
    float phi1 = 2.0f * atan((d1 + sqrt(discriminant1)) / (e1 - f1));
    // 转换 φ₁ 从弧度到角度
    phi1 = phi1 * 180.0f / 3.14159265358979323846f;

    /************* 计算舵机4角度 φ₄ ******************/
    float d2 = 2.0f * l4 * y_pen - 2.0f * l4 * lM * sin(phi0);
    float e2 = 2.0f * l4 * x_pen - 2.0f * l4 * lM * cos(phi0) - 2.0f * l4 * l5;
    float f2 = x_pen * x_pen + y_pen * y_pen + l4 * l4 + lM * lM + l5 * l5 - l3 * l3
               - 2.0f * lM * x_pen * cos(phi0) - 2.0f * l5 * x_pen + 2.0f * lM * l5 * cos(phi0)
               - 2.0f * lM * x_pen * sin(phi0);
    float discriminant2 = d2 * d2 + e2 * e2 - f2 * f2;
    discriminant2 = discriminant2 < 0 ? 0 : discriminant2;
    float phi4 = 2.0f * atan((d2 + sqrt(discriminant2)) / (e2 - f2));
    // 转换 φ₄ 从弧度到角度
    phi4 = phi4 * 180.0f / 3.14159265358979323846f;

    /************* 返回计算结果 ******************/
    angle[0] = phi1;
    angle[1] = phi4;
    return angle;
}
```

以上代码实现了函数 `cla_angle`，通过输入笔尖坐标 $(x_{pen},y_{pen})$ 计算出对应的舵机角度。注释中详细说明了各个中间变量的物理意义和计算公式，便于后续调试和维护。如果需要完善笔尖坐标到工作坐标的转换或更精确地选择双值解，请在此基础上进行扩展。


